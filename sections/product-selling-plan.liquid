<div class="cart-selling-plan-info">
  {%- liquid
    assign current_variant = product.selected_or_first_available_variant | default: product.variants.first
    assign current_selling_plan_allocation = current_variant.selected_selling_plan_allocation

    if current_selling_plan_allocation == null and current_variant.requires_selling_plan
      assign current_selling_plan_allocation = current_variant.selling_plan_allocations | first
    endif

    assign variant_price = current_variant.price | money_without_trailing_zeros | escape
    assign variant_compared_price = current_variant.compare_at_price | money_without_trailing_zeros | escape
  -%}
  <div class="cart-sp-main" data-variant-id="{{ current_variant.id }}">
    <div class="cart-sp-image">
      {% render 'image-element',
        image: product.featured_image,
        widths: '70, 100',
        sizes: '100vw',
        class: 'tw-w-full tw-block tw-object-contain tw-h-auto'
      %}
    </div>
    <div class="cart-sp-text">
      <h4 class="h4">
          {{ product.title }}
      </h4>
      <div class="sp-qty-remove">
        <div class="sp-qty-block">
          <span class="sp-qty-btn sp-qty-minus">
            {{ 'icon-minus.svg' | inline_asset_content }}
          </span>
          <input type="number" name="quantity" value="1" min="1" max="">
          <span class="sp-qty-btn sp-qty-plus">
            {{ 'icon-plus.svg' | inline_asset_content }}
          </span>
        </div>
        <div class="sp-remove">
          {{ 'icon-remove.svg' | inline_asset_content }}
          <span>Remove</span>
        </div>
      </div>
    </div>
  </div>
  <div class="varaint-edit-block flex">
    {%- assign variant_number = current_variant.title |  split: '(' | first |  split: ' ' | last -%}
    {%- assign variant_lbs = current_variant.title |  split: ')' | first |  split: '(' | last -%}
    {%- assign variant_size = current_variant.title |  split: '-' | last -%}
    <div class="varaint-text-left">
      {% if current_variant.title contains 'Size' %}
        <strong>{{ variant_number }}</strong>
        <span>{{ variant_lbs }}</span>
        <strong>{{ variant_size }}</strong>
      {% else %}
        {{ current_variant.title }}
      {% endif %}
    </div>
    <div class="variant-edit-btn">
      {{ 'icon-edit.svg' | inline_asset_content }}
      <span>Edit Size</span>
    </div>
  </div>
  <div class="selling-plan-container-main">
    <div class="selling-plan-main">
      <div class="selling-plan-container tw-mt-[32px]">
        <cart-selling-plan>
          {% if current_variant.selling_plan_allocations.size > 0 %}
            <div data-variant-id="{{ current_variant.id }}" class="csp_item">
              <fieldset class="csp_item-inner">
                {% assign group_ids = current_variant.selling_plan_allocations | map: 'selling_plan_group_id' | uniq %}
                {% for group_id in group_ids %}
                  {% liquid
                    assign group = product | map: 'selling_plan_groups' | where: 'id', group_id | first
                    assign allocations = current_variant | map: 'selling_plan_allocations' | where: 'selling_plan_group_id', group_id

                    if forloop.first
                      assign first_selling_plan_group = true
                    else
                      assign first_selling_plan_group = false
                    endif
                  %}  
                  <ul class="selling_plan-item">
                    {% for allocation in allocations limit: 5 %}
                      {% liquid
                        assign allocationPrice = allocation.price | money_without_trailing_zeros | escape
                        assign allocationComparedAtPrice = allocation.compare_at_price | money_without_trailing_zeros | escape
                      %}
                      <li class="cart-subscription-list{% if forloop.index == 1 %} check-active{% endif %}">
                        <label class="plan-label block w-full relative border border-solid border-[#E3E3E3] rounded-[12px_0_12px_12px] py-[24px] max-md:py-[20px] px-[20px] max-md:px-[16px]" for="{{ section.id }}_selling_plan_{{ allocation.selling_plan.id }}_{{ forloop.index }}_{{ current_variant.id }}">
                          <span class="bes-value absolute bottom-[97%] right-0 max-w-[132px] w-full text-scheme_one-tertiary text-[13px] font-bold font-grotesk leading-none uppercase text-right py-[6px] pr-[15px]">{{ 'best-value.svg' | inline_asset_content }} <span class="absolute z-10 top-[12px] right-[15px]">BEST VALUE</span></span>
                          <div class="flex items-center">
                            <input
                              class="plan-radio appearance-none w-[20px] h-[20px] border border-solid border-[#E3E3E3] rounded-full relative before:content-[''] before:w-[10px] before:h-[10px] before:block before:absolute before:rounded-full flex items-center justify-center"
                              type="radio"
                              id="{{ section.id }}_selling_plan_{{ allocation.selling_plan.id }}_{{ forloop.index }}_{{ current_variant.id }}"
                              {% if current_variant.available == false %}
                              disabled
                              {% endif %}
                              aria-label="{{ allocation.selling_plan.name }}. Product price {{ allocationPrice }}"
                              name="purchaseOption_{{ section.id }}_{{ current_variant.id }}"
                              data-radio-type="selling_plan"
                              data-variant-id="{{ current_variant.id }}"
                              data-selling-plan-id="{{ allocation.selling_plan.id }}"
                              data-selling-plan-group-id="{{ section.id }}_{{ group_id }}_{{ current_variant.id }}"
                              data-selling-plan-adjustment="{{ allocation.selling_plan.price_adjustments.size }}"
                              data-variant-price="{{ allocationPrice }}"
                              data-variant-compare-at-price="{{ allocationComparedAtPrice }}"
                              checked>
                            <div class="title-price w-[calc(100%-20px)] pl-[16px] flex items-center justify-between gap-[10px]">
                              {% assign save_value = allocation.selling_plan.price_adjustments[0].value | divided_by: 100 | round: 2 %}
                              <p class="title-text text-[18px] max-md:text-[15px] text-black-bg font-medium font-grotesk leading-none">
                                Subscribe
                                {% if save_value != 0 %}
                                  &
                                  <span class="save-text">Save {{ save_value }}%</span>
                                {% endif %}
                              </p>
                              <div class="selling-price-box">
                                <div class="selling-price flex items-center gap-[6px]">
                                  {% if save_value != 0 %}
                                    <span class="variant-price text-scheme_two/50 line-through text-[14px] max-md:text-[13px] font-normal font-grotesk leading-none">
                                      {{- current_variant.price | money_without_trailing_zeros -}}
                                    </span>
                                  {% endif %}
                                  <span class="allocation-price text-[18px] max-md:text-[16px] text-black-bg font-medium font-grotesk leading-none">
                                    {{- allocation.price | money_without_trailing_zeros -}}
                                  </span>
                                </div>
                                {% assign serving_text = product.selected_or_first_available_variant.metafields.custom.serving_text %}
                                {% if serving_text != blank %}
                                  <span class="serving-price">
                                    {{ serving_text }}
                                  </span>
                                {% endif %}
                              </div>
                            </div>
                          </div>
                          <div class="plan-detail-text border-0 border-t border-solid border-[#E3E3E3] mt-[20px] max-md:mt-[16px] pt-[20px] max-md:pt-[16px] flex flex-col gap-[20px] max-md:gap-[16px]">
                              <div class="plan-detail-item flex items-center gap-[8px]">
                                {{ 'subscription-right-icon.svg' | inline_asset_content }}
                                <span class="text-[16px] max-md:text-[15px] text-black-bg font-normal font-grotesk leading-none">Free shipping on every order</span>
                              </div>
                              <div class="plan-detail-item flex items-center gap-[8px]">
                                {{ 'subscription-right-icon.svg' | inline_asset_content }}
                                <span class="text-[16px] max-md:text-[15px] text-black-bg font-normal font-grotesk leading-none">Pause or cancel anytime</span>
                              </div>
                            {% if product.selected_or_first_available_variant.selling_plan_allocations.size < 1 %}
                              <div class="plan-detail-item flex items-center gap-[8px]">
                                {{ 'subscription-right-icon.svg' | inline_asset_content }}
                                <span class="text-[16px] max-md:text-[15px] text-black-bg font-normal font-grotesk leading-none">{{ allocation.selling_plan.name }}</span>
                              </div>
                            {% else %}
                              <div class="plan-detail-item">
                                <div class="plan-detail-select">
                                  <select
                                    class="selling-plan-dropdown border border-solid border-scheme_two rounded-[6px] py-[12px] px-[12px] w-full bg-[url('https://cdn.shopify.com/s/files/1/0616/2835/0723/files/Vector_98962381-27e9-4ae8-a80b-9c15c6124b8a.png?v=1758803348')] bg-no-repeat bg-[length:10px_7px] bg-[97%] appearance-none bg-[transparent] !outline-none text-[13px] text-black-bg font-normal font-grotesk leading-none {% if product.selected_or_first_available_variant.selling_plan_allocations.size < 1 %} hidden{% endif %}"
                                    name="selling-plan"
                                    data-line="{{ forloop.index }}"
                                    data-quantity="1">
                                    {% for selling_plan_allocation in product.selected_or_first_available_variant.selling_plan_allocations %}
                                      <option
                                        value="{{ selling_plan_allocation.selling_plan.id }}"
                                        {% if product.selling_plan_allocation.selling_plan.id == selling_plan_allocation.selling_plan.id %}
                                        selected="selected"
                                        {% endif %}>

                                        {% if selling_plan_allocation.selling_plan.name == 'Delivered Monthly' %}
                                          Deliver every 30 days
                                        {% else %}
                                          every {{ selling_plan_allocation.selling_plan.name }}
                                        {% endif %}
                                      </option>
                                    {% endfor %}
                                  </select>
                                </div>
                              </div>
                            {% endif %}
                          </div>
                        </label>
                      </li>
                    {% endfor %}
                    <li class="cart-subscription-list mt-[10px]">
                      <label class="subscription-label block w-full relative border border-solid border-[#E3E3E3] rounded-[12px] py-[24px] max-md:py-[20px] px-[20px] max-md:px-[16px]" for="{{ section.id }}_one_time_purchase_{{ current_variant.id }}">
                        <div class="flex items-center">
                          <input
                            class="subscription-input appearance-none w-[20px] h-[20px] border border-solid border-[#E3E3E3] rounded-full relative before:content-[''] before:w-[10px] before:h-[10px] before:block before:absolute before:rounded-full flex items-center justify-center"
                            aria-label="One-time purchase. Product price {{ variant_price }}"
                            type="radio"
                            id="{{ section.id }}_one_time_purchase_{{ current_variant.id }}"
                            name="purchaseOption_{{ section.id }}_{{ current_variant.id }}"
                            {% if current_variant.available == false %}
                            disabled
                            {% endif %}
                            id="{{ section.id }}_one_time_purchase"
                            data-radio-type="one_time_purchase"
                            data-variant-id="{{ current_variant.id }}"
                            data-variant-price="{{ variant_price }}"
                            data-variant-compare-at-price="{{ variant_compared_price }}">
                          <div class="title-price w-[calc(100%-20px)] pl-[16px] flex items-center justify-between gap-[10px]">
                            <p class="title-text text-[18px] max-md:text-[15px] text-black-bg font-medium font-grotesk leading-none">
                              One-Time Purchase
                            </p>
                            <div class="selling-price-box">
                              <div class="selling-price flex items-center gap-[6px]">
                                <span class="allocation-price text-[18px] max-md:text-[16px] text-black-bg font-medium font-grotesk leading-none">
                                  {{- current_variant.price | money_without_trailing_zeros -}}
                                </span>
                              </div>
                            </div>
                          </div>
                        </div>
                      </label>
                    </li>
                  </ul>
                {% endfor %}
              </fieldset>
            </div>
          {% endif %}
        </cart-selling-plan>
      </div>
    </div>
  </div>

</div>  

