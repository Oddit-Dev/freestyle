{%- assign current_variant = product.selected_or_first_available_variant | default: product.variants.first -%}
{% if product.selling_plan_groups.size > 0 %}
  <div class="label-main flex items-center gap-[8px] mb-[20px] max-md:mb-[20px]">
    <label class="text-[16px] text-black-bg font-medium font-grotesk leading-none">Select Plan:</label>
    <span class="selected-plan text-[16px] font-medium font-grotesk leading-none text-[#7A7A7A] max-md:max-w-[140px] max-md:w-full max-md:line-clamp-1"></span>
  </div>
  <div class="selling_plan_app_container" data-section-id="{{ section.id }}">
    {% for variant in product.variants %}
      {% liquid
        assign variantPrice = variant.price | money_without_trailing_zeros | escape
        assign variantComparedAtPrice = variant.compare_at_price | money_without_trailing_zeros | escape
      %}
      {% if variant.selling_plan_allocations.size > 0 %}
        <section data-variant-id="{{ variant.id }}" class="selling_plan_theme_integration {% if variant.id != current_variant.id %}hidden{% endif %}">
          <fieldset class="selling_plan_theme_integration-inner">
            {% assign group_ids = variant.selling_plan_allocations | map: 'selling_plan_group_id' | uniq %}
            {% for group_id in group_ids %}
              {% liquid
                assign group = product | map: 'selling_plan_groups' | where: 'id', group_id | first
                assign allocations = variant | map: 'selling_plan_allocations' | where: 'selling_plan_group_id', group_id

                if forloop.first
                  assign first_selling_plan_group = true
                else
                  assign first_selling_plan_group = false
                endif
              %}
              <ul class="selling_plan-item">
                {% for allocation in allocations limit: 1 %}
                  {% liquid
                    if forloop.first and product.requires_selling_plan and first_selling_plan_group
                      assign plan_checked = 'checked'
                    else
                      assign plan_checked = null
                    endif

                    assign allocationPrice = allocation.price | money_without_trailing_zeros | escape
                    assign allocationComparedAtPrice = allocation.compare_at_price | money_without_trailing_zeros | escape
                  %}

                  <li class="subscription-list{% if forloop.index == 1 %} check-active{% endif %}">
                    <label class="plan-label block w-full relative border border-solid border-[#E3E3E3] rounded-[12px_0_12px_12px] py-[24px] max-md:py-[20px] px-[20px] max-md:px-[16px]" for="{{ section.id }}_selling_plan_{{ allocation.selling_plan.id }}_{{ forloop.index }}_{{ variant.id }}">
                      <span class="bes-value absolute bottom-[97%] right-0 max-w-[132px] w-full text-scheme_one-tertiary text-[13px] font-bold font-grotesk leading-none uppercase text-right py-[6px] pr-[15px]">{{ 'best-value.svg' | inline_asset_content }} <span class="absolute z-10 top-[12px] right-[15px]">BEST VALUE</span></span>
                      <div class="flex items-center">
                        <input
                          class="plan-radio appearance-none w-[20px] h-[20px] border border-solid border-[#E3E3E3] rounded-full relative before:content-[''] before:w-[10px] before:h-[10px] before:block before:absolute before:rounded-full flex items-center justify-center"
                          type="radio"
                          id="{{ section.id }}_selling_plan_{{ allocation.selling_plan.id }}_{{ forloop.index }}_{{ variant.id }}"
                          {% if variant.available == false %}
                          disabled
                          {% endif %}
                          aria-label="{{ allocation.selling_plan.name }}. Product price {{ allocationPrice }}"
                          name="purchaseOption_{{ section.id }}_{{ variant.id }}"
                          data-radio-type="selling_plan"
                          data-selling-plan-id="{{ allocation.selling_plan.id }}"
                          data-selling-plan-group-id="{{ section.id }}_{{ group_id }}_{{ variant.id }}"
                          data-selling-plan-adjustment="{{ allocation.selling_plan.price_adjustments.size }}"
                          data-variant-price="{{ allocationPrice }}"
                          data-variant-compare-at-price="{{ allocationComparedAtPrice }}"
                          checked>
                        <div class="title-price w-[calc(100%-20px)] pl-[16px] flex items-center justify-between gap-[10px]">
                          {% assign save_value = allocation.selling_plan.price_adjustments[0].value | divided_by: 100 | round: 2 %}
                          <p class="title-text text-[18px] max-md:text-[15px] text-black-bg font-medium font-grotesk leading-none">
                            Subscribe
                            {% if save_value != 0 %}
                              &
                              <span class="save-text">Save {{ save_value }}%</span>
                            {% endif %}
                          </p>
                          <div class="selling-price-box">
                            <div class="selling-price flex items-center gap-[6px]">
                              {% if save_value != 0 %}
                                <span class="variant-price text-scheme_two/50 line-through text-[14px] max-md:text-[13px] font-normal font-grotesk leading-none">
                                  {{- variant.price | money_without_trailing_zeros -}}
                                </span>
                              {% endif %}
                              <span class="allocation-price text-[18px] max-md:text-[16px] text-black-bg font-medium font-grotesk leading-none" data-original-price="{{ allocation.price | money_without_trailing_zeros | escape }}">
                                {{- allocation.price | money_without_trailing_zeros -}}
                              </span>
                            </div>
                            {% assign serving_text = product.selected_or_first_available_variant.metafields.custom.serving_text %}
                            {% if serving_text != blank %}
                              <span class="serving-price">
                                {{ serving_text }}
                              </span>
                            {% endif %}
                          </div>
                        </div>
                      </div>
                      <div class="plan-detail-text border-0 border-t border-solid border-[#E3E3E3] mt-[20px] max-md:mt-[16px] pt-[20px] max-md:pt-[16px] flex flex-col gap-[20px] max-md:gap-[16px]">
                        {% if block.settings.free_shipping != blank %}
                          <div class="plan-detail-item flex items-center gap-[8px]">
                            {{ 'subscription-right-icon.svg' | inline_asset_content }}
                            <span class="text-[16px] max-md:text-[15px] text-black-bg font-normal font-grotesk leading-none">{{ block.settings.free_shipping }}</span>
                          </div>
                        {% endif %}
                        {% if block.settings.cancel_text != blank %}
                          <div class="plan-detail-item flex items-center gap-[8px]">
                            {{ 'subscription-right-icon.svg' | inline_asset_content }}
                            <span class="text-[16px] max-md:text-[15px] text-black-bg font-normal font-grotesk leading-none">{{ block.settings.cancel_text }}</span>
                          </div>
                        {% endif %}
                        {% if product.selected_or_first_available_variant.selling_plan_allocations.size < 1 %}
                          <div class="plan-detail-item flex items-center gap-[8px]">
                            {{ 'subscription-right-icon.svg' | inline_asset_content }}
                            <span class="text-[16px] max-md:text-[15px] text-black-bg font-normal font-grotesk leading-none">{{ allocation.selling_plan.name }}</span>
                          </div>
                        {% else %}
                          <div class="plan-detail-item">
                            {% if block.settings.plan_text != blank %}
                              <span class="text-[16px] max-md:text-[15px] text-black-bg font-normal font-grotesk leading-none">{{ block.settings.plan_text }}</span>
                            {% endif %}
                            <div class="plan-detail-select">
                              <select
                                class="selling-plan-dropdown border border-solid border-scheme_two rounded-[6px] py-[12px] px-[12px] w-full bg-[url('https://cdn.shopify.com/s/files/1/0616/2835/0723/files/Vector_98962381-27e9-4ae8-a80b-9c15c6124b8a.png?v=1758803348')] bg-no-repeat bg-[length:10px_7px] bg-[97%] appearance-none bg-[transparent] !outline-none text-[13px] text-black-bg font-normal font-grotesk leading-none {% if product.selected_or_first_available_variant.selling_plan_allocations.size < 1 %} hidden{% endif %}"
                                name="selling-plan"
                                data-line="{{ forloop.index }}"
                                data-quantity="{{ item.quantity }}">
                                {% for selling_plan_allocation in product.selected_or_first_available_variant.selling_plan_allocations %}
                                  <option
                                    value="{{ selling_plan_allocation.selling_plan.id }}"
                                    {% if item.selling_plan_allocation.selling_plan.id == selling_plan_allocation.selling_plan.id %}
                                    selected="selected"
                                    {% endif %}>

                                    {% if selling_plan_allocation.selling_plan.name == 'Delivered Monthly' %}
                                      Deliver every 30 days
                                    {% else %}
                                      every {{ selling_plan_allocation.selling_plan.name }}
                                    {% endif %}
                                  </option>
                                {% endfor %}
                              </select>
                            </div>
                          </div>
                        {% endif %}
                      </div>
                    </label>
                  </li>
                {% endfor %}
                <li class="subscription-list mt-[10px]">
                  <label class="subscription-label block w-full relative border border-solid border-[#E3E3E3] rounded-[12px] py-[24px] max-md:py-[20px] px-[20px] max-md:px-[16px]" for="{{ section.id }}_one_time_purchase_{{ variant.id }}">
                    <div class="flex items-center">
                      <input
                        class="subscription-input appearance-none w-[20px] h-[20px] border border-solid border-[#E3E3E3] rounded-full relative before:content-[''] before:w-[10px] before:h-[10px] before:block before:absolute before:rounded-full flex items-center justify-center"
                        aria-label="One-time purchase. Product price {{ variantPrice }}"
                        type="radio"
                        id="{{ section.id }}_one_time_purchase_{{ variant.id }}"
                        name="purchaseOption_{{ section.id }}_{{ variant.id }}"
                        {% if variant.available == false %}
                        disabled
                        {% endif %}
                        id="{{ section.id }}_one_time_purchase"
                        data-radio-type="one_time_purchase"
                        data-variant-id="{{ variant.id }}"
                        data-variant-price="{{ variantPrice }}"
                        data-variant-compare-at-price="{{ variantComparedAtPrice }}">
                      <div class="title-price w-[calc(100%-20px)] pl-[16px] flex items-center justify-between gap-[10px]">
                        <p class="title-text text-[18px] max-md:text-[15px] text-black-bg font-medium font-grotesk leading-none">
                          One-Time Purchase
                        </p>
                        <div class="selling-price-box">
                          <div class="selling-price flex items-center gap-[6px]">
                            <span class="allocation-price text-[18px] max-md:text-[16px] text-black-bg font-medium font-grotesk leading-none" data-original-price="{{ variant.price | money_without_trailing_zeros | escape }}">
                              {{- variant.price | money_without_trailing_zeros -}}
                            </span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </label>
                </li>
              </ul>
            {% endfor %}
          </fieldset>
        </section>
      {% endif %}
    {% endfor %}
  </div>
{% endif %}
