{%- assign current_variant = product.selected_or_first_available_variant | default: product.variants.first -%}
{% if product.selling_plan_groups.size > 0 %}
  <div class="label-main">
  <label>Select Plan:</label>
  <span class="selected-plan"></span>
  </div>
  <div class="selling_plan_app_container" data-section-id="{{ section.id }}">
    {% for variant in product.variants %}
      {% liquid
        assign variantPrice = variant.price | money_without_trailing_zeros | escape
        assign variantComparedAtPrice = variant.compare_at_price | money_without_trailing_zeros | escape
      %}
      {% if variant.selling_plan_allocations.size > 0 %}
        <section
          data-variant-id="{{ variant.id }}"
          class="selling_plan_theme_integration {% if variant.id != current_variant.id %}hidden{% endif %}"
        >
          <fieldset class="selling_plan_theme_integration-inner">
            <div>
              {% assign group_ids = variant.selling_plan_allocations | map: 'selling_plan_group_id' | uniq %}
              {% for group_id in group_ids %}
                {% liquid
                  assign group = product | map: 'selling_plan_groups' | where: 'id', group_id | first
                  assign allocations = variant | map: 'selling_plan_allocations' | where: 'selling_plan_group_id', group_id

                  if forloop.first
                    assign first_selling_plan_group = true
                  else
                    assign first_selling_plan_group = false
                  endif
                %}
                <div>
                  <ul class="selling_plan-item">
                    {% for allocation in allocations limit: 1 %}
                      
                      {% liquid
                        if forloop.first and product.requires_selling_plan and first_selling_plan_group
                          assign plan_checked = 'checked'
                        else
                          assign plan_checked = null
                        endif

                        assign allocationPrice = allocation.price | money_without_trailing_zeros | escape
                        assign allocationComparedAtPrice = allocation.compare_at_price | money_without_trailing_zeros | escape
                      %}

                      <li class="subscription-list">
                        <label
                          class="plan-label"
                          for="{{ section.id }}_selling_plan_{{ allocation.selling_plan.id }}_{{ forloop.index }}_{{ variant.id }}"
                        >
                          <span class="bes-value">BEST VALUE</span><br>
                          <input
                            class="plan-radio"
                            type="radio"
                            id="{{ section.id }}_selling_plan_{{ allocation.selling_plan.id }}_{{ forloop.index }}_{{ variant.id }}"
                            {% if variant.available == false %}
                              disabled
                            {% endif %}
                            aria-label="{{ allocation.selling_plan.name }}. Product price {{ allocationPrice }}"
                            name="purchaseOption_{{ section.id }}_{{ variant.id }}"
                            data-radio-type="selling_plan"
                            data-selling-plan-id="{{ allocation.selling_plan.id }}"
                            data-selling-plan-group-id="{{ section.id }}_{{ group_id }}_{{ variant.id }}"
                            data-selling-plan-adjustment="{{ allocation.selling_plan.price_adjustments.size }}"
                            data-variant-price="{{ allocationPrice }}"
                            data-variant-compare-at-price="{{ allocationComparedAtPrice }}"
                            checked
                          >
                          <div class="title-price">
                            <p class="title-text">
                              Subscribe &
                              <span class="save-text"
                                >Save {{ allocation.selling_plan.price_adjustments[0].value }}%</span
                              >
                            </p>
                            <div class="selling-price-box">
                              <div class="selling-price">
                                <span class="allocation-price">
                                  {{- allocation.price | money_without_trailing_zeros -}}
                                </span>
                                <span class="variant-price">
                                  {{- variant.price | money_without_trailing_zeros -}}
                                </span>
                              </div>
                              {% assign serving_text = product.selected_or_first_available_variant.metafields.custom.serving_text %}
                              {% if serving_text != blank %}
                                <span class="serving-price">
                                  {{ serving_text }}
                                </span>
                              {% endif %}
                            </div>
                          </div>

                          <div class="plan-detail-text">
                            {% if block.settings.free_shipping != blank %}
                              <div class="plan-detail-item">
                                <span>{{ block.settings.free_shipping }}</span>
                              </div>
                            {% endif %}
                            {% if block.settings.cancel_text != blank %}
                              <div class="plan-detail-item">
                                <span>{{ block.settings.cancel_text }}</span>
                              </div>
                            {% endif %}
                            {% if product.selected_or_first_available_variant.selling_plan_allocations.size < 1 %}
                              <div class="plan-detail-item">
                                <span>{{ allocation.selling_plan.name }}</span>
                              </div>
                            {% else %}
                              <div class="plan-detail-item">
                                {% if block.settings.plan_text != blank %}
                                  <span>{{ block.settings.plan_text }}</span>
                                {% endif %}
                                <div class="plan-detail-select">
                                  <select
                                    class="selling-plan-dropdown{% if product.selected_or_first_available_variant.selling_plan_allocations.size < 1 %} hidden{% endif %}"
                                    name="selling-plan"
                                    data-line="{{ forloop.index }}"
                                    data-quantity="{{ item.quantity }}"
                                  >
                                    {% for selling_plan_allocation in product.selected_or_first_available_variant.selling_plan_allocations %}
                                      <option
                                        value="{{ selling_plan_allocation.selling_plan.id }}"
                                        {% if item.selling_plan_allocation.selling_plan.id
                                            == selling_plan_allocation.selling_plan.id
                                        %}
                                          selected="selected"
                                        {% endif %}
                                      >
                                      
                                        {% if selling_plan_allocation.selling_plan.name == 'Delivered Monthly' %}
                                         Deliver every 30 days
                                        {% else %}
                                          every {{ selling_plan_allocation.selling_plan.name }}
                                        {% endif %}
                                      </option>
                                    {% endfor %}
                                  </select>
                                </div>
                              </div>
                            {% endif %}
                          </div>
                        </label>
                      </li>
                    {% endfor %}
                    <li class="subscription-list">
                      <label
                        class="subscription-label"
                        for="{{ section.id }}_one_time_purchase_{{ variant.id }}"
                      >
                        <input
                          class="subscription-input"
                          aria-label="One-time purchase. Product price {{ variantPrice }}"
                          type="radio"
                          id="{{ section.id }}_one_time_purchase_{{ variant.id }}"
                          name="purchaseOption_{{ section.id }}_{{ variant.id }}"
                          {% if variant.available == false %}
                            disabled
                          {% endif %}
                          id="{{ section.id }}_one_time_purchase"
                          data-radio-type="one_time_purchase"
                          data-variant-id="{{ variant.id }}"
                          data-variant-price="{{ variantPrice }}"
                          data-variant-compare-at-price="{{ variantComparedAtPrice }}"
                        >
                        <div class="title-price">
                          <p class="title-text">
                            One-Time Purchase
                          </p>
                          <div class="selling-price-box">
                            <div class="selling-price">
                              <span class="allocation-price">
                                {{- variant.price | money_without_trailing_zeros -}}
                              </span>
                            </div>
                          </div>
                        </div>
                      </label>
                    </li>
                  </ul>
                </div>
              {% endfor %}
            </div>
          </fieldset>
        </section>
      {% endif %}
    {% endfor %}
  </div>
{% endif %}
